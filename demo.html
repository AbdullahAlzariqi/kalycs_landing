<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Folder Organizer — Demo</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
  <!-- Styles -->
  <link rel="stylesheet" href="styles.min.css">
  <!-- JSZip + FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    /* Demo-specific background override */
    body.demo-page {
      background: radial-gradient(1200px 800px at 10% -10%, rgba(90,63,207,.25), transparent 60%),
                  radial-gradient(1000px 600px at 110% 10%, rgba(185,168,249,.15), transparent 50%),
                  #0B0D19 !important;
    }
    /* Override global .badge (40x40 icon style) inside demo */
    .demo-page .badge {
      width: auto;
      height: auto;
      box-shadow: none;
      display: inline-block;
      white-space: nowrap;
    }

    /* Layout: two-column grid to keep preview visible */
    .demo-page .shell > .grid {
      display: grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 18px;
      align-items: start;
    }
    /* Step 3: focus on preview */
    .demo-page .shell.step-3 > .grid { grid-template-columns: 1fr; }
    .demo-page .shell.step-3 #left-panel { display: none; }
    .demo-page .shell.step-3 #preview-panel { display: block; }
    @media (max-width: 980px) {
      .demo-page .shell > .grid { grid-template-columns: 1fr; }
    }

    /* Keep rules from pushing actions/preview down */
    .demo-page .rules {
      max-height: 46vh;
      overflow: auto;
      padding-right: 4px; /* room for scrollbar */
    }

    /* Tone down limitation cards so they don't look clickable */
    .demo-page .limits { gap: 6px; margin-top: 12px; }
    .demo-page .lim {
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
    }
    .demo-page .lim b { color: var(--muted) !important; font-weight: 700; }
    .demo-page .lim span { color: var(--muted) !important; }

    /* Preview overlay */
    .demo-page .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      z-index: 9999;
      padding: 14px;
      box-sizing: border-box;
      align-items: center;
      justify-content: center;
    }
    .demo-page .preview-overlay.is-open { display: flex; }
    .demo-page .overlay-panel {
      width: min(1400px, 98vw);
      height: min(94vh, 1000px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      overflow: hidden;
    }
    .demo-page .overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .demo-page .overlay-title { margin: 0; font-size: 16px; }
    .demo-page .overlay-actions { display:flex; gap:8px; align-items:center; }
    .demo-page .overlay-content { padding: 0; overflow: hidden; display:flex; }
    .demo-page .overlay-footer { padding: 6px 10px; border-top: 1px solid rgba(255,255,255,.08); }

    /* Let the preview table occupy the space */
    .demo-page .preview-overlay .preview {
      flex: 1;
      height: 100%;
      max-height: none;
      margin: 0;
      border: none;
      border-radius: 0;
      overflow: auto;
    }

    /* Compact celebratory modal for downloads */
    .demo-page #thanksOverlay .overlay-panel.thanks {
      width: min(520px, 92vw);
      height: auto;
      grid-template-rows: auto auto auto;
    }
    .demo-page #thanksOverlay .overlay-header {
      border-bottom: none;
      padding: 10px 14px 0;
    }
    .demo-page #thanksOverlay .overlay-content { padding: 0 14px 6px; overflow: visible; }
    .demo-page .celebrate { position: relative; display: grid; place-items: center; gap: 10px; padding: 6px 0 10px; }
    .demo-page .celebrate .icon-ring {
      width: 56px; height: 56px; border-radius: 50%; display: grid; place-items: center;
      color: #fff; font-weight: 800; font-size: 20px;
      background: conic-gradient(from 180deg, var(--main-violet), var(--primary-indigo));
      box-shadow: 0 6px 18px rgba(88,92,218,.35), inset 0 0 0 1px rgba(255,255,255,.12);
      position: relative; isolation: isolate;
    }
    .demo-page .icon-ring::after{ content:""; position:absolute; inset:4px; border-radius:50%; background: rgba(255,255,255,.08); }
    .demo-page .celebrate .headline { margin: 6px 0 0; font-weight: 800; font-size: 18px; text-align:center; }
    .demo-page .celebrate .sub { margin: 0; color: var(--muted); font-size: 14px; text-align: center; max-width: 60ch; }
    .demo-page #thanksOverlay .overlay-footer { display:flex; gap:8px; justify-content:flex-end; align-items:center; padding: 8px 10px 12px; }
    
    /* Compact upload confirm modal */
    .demo-page #uploadConfirmOverlay .overlay-panel.confirm {
      width: min(520px, 92vw);
      height: auto;
      grid-template-rows: auto auto auto;
    }
    .demo-page #uploadConfirmOverlay .overlay-header { border-bottom: none; padding: 10px 14px 0; }
    .demo-page #uploadConfirmOverlay .overlay-content { padding: 0 14px 6px; overflow: visible; }
    .demo-page #uploadConfirmOverlay .overlay-footer { display:flex; gap:8px; justify-content:flex-end; align-items:center; padding: 8px 10px 12px; }
    .demo-page .upload-summary { text-align:center; color: rgba(255,255,255,.92); margin: 0; }
    .demo-page .upload-summary b { color: #fff; }
    .demo-page .upload-note { text-align:center; color: var(--muted); font-size: 14px; margin: 6px 0 0; }

    /* Stepper */
    .demo-page .stepper {
      display: flex;
      gap: 8px;
      margin: 8px 0 14px;
      align-items: center;
      flex-wrap: wrap;
    }
    .demo-page .stepper .step {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
    }
    .demo-page .stepper .step[disabled] { opacity: .5; cursor: not-allowed; }
    .demo-page .stepper .step .step-index {
      width: 22px; height: 22px;
      display: inline-grid; place-items: center;
      border-radius: 50%; font-size: 12px;
      background: rgba(255,255,255,.08);
    }
    .demo-page .stepper .step.is-active {
      border-color: rgba(142,125,255,.9);
      box-shadow: 0 0 0 2px rgba(142,125,255,.15) inset;
    }
    .demo-page .stepper .step.is-completed {
      background: linear-gradient(180deg, rgba(142,125,255,.25), rgba(142,125,255,.15));
      border-color: rgba(142,125,255,.65);
    }

    /* Wizard nav */
    .demo-page .wizard-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 12px;
    }
    .demo-page .wizard-nav #to-step-2[disabled],
    .demo-page .wizard-nav #to-step-3[disabled],
    .demo-page .inline #downloadInPreview[disabled] { opacity: .5; cursor: not-allowed; }
    
    /* Compact site header on demo */
    .demo-page .site-header { 
      backdrop-filter: blur(8px); 
      -webkit-backdrop-filter: blur(8px);
      background: rgba(11,13,25,0.55);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .demo-page .site-header .nav { padding: 10px 0; }
    .demo-page .brand__logo { width: 28px; height: 28px; }
    .demo-page .brand__name { font-size: 16px; font-weight: 700; }
    .demo-page .nav__toggle, .demo-page .nav__links, .demo-page .nav__buy-btn { display: none !important; }
    .demo-page .demo-back { margin-left: auto; font-size: 13px; font-weight: 700; color: #e6e6ff; text-decoration: none; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); }
    .demo-page .demo-back:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); }

    /* Page intro (compact) */
    .demo-page .page-intro { 
      padding: 10px 0 8px; 
      margin: 0 auto 6px; 
      max-width: 1200px; 
      display: grid; 
      gap: 6px;
    }
    .demo-page .intro-row { display: inline-flex; align-items: center; gap: 10px; }
    .demo-page .intro-badge { 
      display: inline-block; padding: 4px 10px; border-radius: 999px; 
      font-size: 12px; font-weight: 800; letter-spacing: .04em; 
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); color: var(--muted);
    }
    .demo-page .intro-title { font-size: 18px; margin: 0; font-weight: 800; color: var(--text); }
    .demo-page .intro-details { font-size: 13px; color: var(--muted); }
    .demo-page .intro-details > summary { cursor: pointer; list-style: none; }
    .demo-page .intro-details > summary::-webkit-details-marker { display: none; }
    .demo-page .intro-details > summary::after { content: '›'; display: inline-block; transform: rotate(90deg); margin-left: 6px; opacity: .7; }
    .demo-page .intro-details[open] > summary::after { transform: rotate(-90deg); }
  </style>
</head>
<body class="demo-page">
  <!-- Site Header / Nav -->
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="index.html">
        <picture>
          <source srcset="assets/logo.webp" type="image/webp" />
          <img src="assets/logo.png" alt="Kalycs logo" class="brand__logo" width="40" height="40" />
        </picture>
        <span class="brand__name">Kalycs</span>
      </a>

      <button class="nav__toggle" aria-controls="primary-menu" aria-expanded="false">
        <span class="sr-only">Toggle menu</span>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>

      <nav id="primary-menu" class="nav__links" aria-label="Primary">
        <div class="nav__pill">
          <a href="index.html#main">Home</a>
          <a href="index.html#features">Features</a>
          <a href="blog/">Blog</a>
          <a href="privacy.html">Privacy</a>
        </div>
      </nav>
      <a class="demo-back" href="index.html">Back to Home</a>
    </div>
  </header>
  <header class="page-intro" aria-labelledby="pageTitle">
    <div class="intro-row">
      <span class="intro-badge">Demo</span>
      <h1 id="pageTitle" class="intro-title">Folder Organizer</h1>
    </div>
    <details class="intro-details">
      <summary>How this demo works</summary>
      <p>Upload a folder, set simple rules, then download a neatly organized <b>ZIP</b>. Everything stays on your device.</p>
    </details>
  </header>

  <div class="shell">
    <!-- Stepper -->
    <nav class="stepper" id="stepper" aria-label="Setup steps">
      <button class="step is-active" data-step="1" aria-current="step">
        <span class="step-index">1</span>
        <span class="step-label">Upload</span>
      </button>
      <button class="step" data-step="2">
        <span class="step-index">2</span>
        <span class="step-label">Rules</span>
      </button>
      <button class="step" data-step="3">
        <span class="step-index">3</span>
        <span class="step-label">Preview</span>
      </button>
    </nav>
    <div class="hint" style="margin: -4px 0 12px;">
      Reminder: Kalycs can automatically organize your files on the go.
    </div>
    <div class="grid">
    <section class="card" id="left-panel">
      <!-- Tabs -->
      <div class="tabs" id="legacyTabs" aria-hidden="true" style="display:none"></div>

      <!-- Upload Tab Content -->
      <div class="tab-content active" id="upload-tab">
        <h2>Upload Folder</h2>
        <div class="filebox">
          <label for="dir">Choose a folder</label>
          <input id="dir" type="file" webkitdirectory directory multiple />
          <button class="btn secondary" id="dirPickerBtn" type="button" style="margin-top:8px; display:none">Choose a folder</button>
          <div class="stat" id="stat">No files selected.</div>
        </div>

        <div class="limits">
          <div class="lim"><b>Max total files</b><span id="maxFiles"></span></div>
          <div class="lim"><b>Max total size</b><span id="maxSize"></span></div>
          <div class="lim"><b>Max file size</b><span id="maxFileSize"></span></div>
          <div class="lim"><b>Max folder depth</b><span id="maxDepth"></span></div>
        </div>
        <div class="wizard-nav" id="wizard-nav-1">
          <button class="btn ghost" id="to-step-2" disabled>Next →</button>
        </div>
      </div>

      <!-- Rules Tab Content -->
      <div class="tab-content" id="rules-tab">
        <h2>Set Up Rules</h2>
        <p class="hint" style="margin-bottom:16px">Rules run top to bottom — first match wins. Each rule moves matching files into the folder you name.</p>
        
        <div class="rules" id="rules"></div>
        
        <div class="toolbar">
          <button class="btn secondary" id="addRule">+ Add Rule</button>
          <button class="btn ghost" id="sampleRules">Load sample rules</button>
        </div>
        
        <div class="toolbar" style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,.08)">
          <button class="btn primary" id="previewBtn"><span style="color:#fff; font-weight:700;">Preview</span></button>
          <button class="btn secondary" id="download" disabled>Download Organized ZIP</button>
          <button class="btn warn" id="reset">Start Over</button>
        </div>

        <div class="wizard-nav" id="wizard-nav-2">
          <button class="btn ghost" id="back-to-1">← Back</button>
          <div style="flex:1"></div>
          <button class="btn ghost" id="to-step-3" disabled>Next →</button>
        </div>
      </div>
    </section>

    <!-- Preview Table -->
    <section class="card" id="preview-panel">
      <div class="inline" style="align-items:center; justify-content: space-between;">
        <h2 style="margin:0">Preview</h2>
        <div class="inline" style="gap:8px; align-items:center;">
          <button class="btn secondary" id="downloadInPreview" disabled>Download</button>
          <button class="btn ghost" id="expandPreview">Expand</button>
        </div>
      </div>
      <div class="hint">See where your files will land. Anything that doesn’t match a rule goes to <code class="inline">Others/</code>.</div>
      <div id="violations" class="hint" style="margin-top:8px;color:var(--danger)"></div>
      <div class="preview" id="preview"></div>
      <div id="pagination"></div>
      <div class="wizard-nav" id="wizard-nav-3">
        <button class="btn ghost" id="back-to-2">← Back</button>
      </div>
    </section>
    </div>
  </div>

  <!-- Preview Overlay -->
  <div class="preview-overlay" id="previewOverlay" aria-hidden="true">
    <div class="overlay-panel" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlay-header">
        <h3 class="overlay-title" id="overlayTitle">Preview</h3>
        <div class="overlay-actions">
          <button class="btn secondary" id="downloadOverlay" disabled>Download Organized ZIP</button>
          <button class="btn ghost" id="closeOverlay">Close</button>
        </div>
      </div>
      <div class="overlay-content">
        <div class="preview" id="overlayPreview"></div>
      </div>
      <div class="overlay-footer">
        <div id="overlayPagination"></div>
      </div>
    </div>
  </div>

  <!-- Download Thanks Overlay -->
  <div class="preview-overlay" id="thanksOverlay" aria-hidden="true">
    <div class="overlay-panel thanks" role="dialog" aria-modal="true" aria-labelledby="thanksTitle" aria-describedby="thanksDesc">
      <div class="overlay-header">
      </div>
      <div class="overlay-content">
        <div class="celebrate">
          <div class="icon-ring">✓</div>
          <p class="headline">All Organized — That Was Easy ✨</p>
          <p id="thanksDesc" class="sub">Thanks for downloading your organized ZIP. With Kalycs, one setup is all it takes—your folders organize themselves automatically.</p>
        </div>
      </div>
      <div class="overlay-footer">
        <a class="btn ghost" href="index.html#features">Learn more</a>
        <a class="btn primary" id="thanksCta" href="index.html#main"><span style="font-weight:700;color:#fff;">Get Kalycs</span></a>
        <button class="btn secondary" id="thanksConfirm">Got it</button>
      </div>
    </div>
  </div>

  <!-- Upload Confirm Overlay -->
  <div class="preview-overlay" id="uploadConfirmOverlay" aria-hidden="true">
    <div class="overlay-panel confirm" role="dialog" aria-modal="true" aria-labelledby="uploadConfirmTitle" aria-describedby="uploadConfirmDesc">
      <div class="overlay-header">
        <h3 class="overlay-title" id="uploadConfirmTitle">Folder Added</h3>
      </div>
      <div class="overlay-content">
        <div class="celebrate">
          <div class="icon-ring" aria-hidden="true">📁</div>
          <p id="uploadConfirmDesc" class="upload-summary">We found <b id="ucCount">0 files</b> • <b id="ucSize">0</b></p>
          <p class="upload-note">Files stay on your device. Next, set simple rules so Kalycs can keep this folder tidy automatically.</p>
        </div>
        <div id="uploadViolations" class="hint" style="color:var(--danger); text-align:center;"></div>
      </div>
      <div class="overlay-footer">
        <button class="btn ghost" id="ucReselect">Reselect folder</button>
        <button class="btn primary" id="ucContinue"><span style="font-weight:700;color:#fff;">Continue</span></button>
      </div>
    </div>
  </div>

  <footer>
    <p><b>Demo constraints</b>: in‑browser only; large folders may be slow. Works best on Chromium‑based browsers. No data is uploaded.</p>
  </footer>

<script src="script.min.js"></script>
<script>
(function(){
  // ===== Demo Limits (tweak freely) =====
  const LIMITS = {
    MAX_FILES: 800,                  // total files
    MAX_TOTAL_BYTES: 200 * 1024**2,  // 200 MB
    MAX_FILE_BYTES: 25 * 1024**2,    // 25 MB per file
    MAX_DEPTH: 12                    // folder depth by path segments
  };

    const els = {
    input: document.getElementById('dir'),
    stat: document.getElementById('stat'),
    rules: document.getElementById('rules'),
    addRule: document.getElementById('addRule'),
    sampleRules: document.getElementById('sampleRules'),
    previewBtn: document.getElementById('previewBtn'),
    downloadBtn: document.getElementById('download'),
    downloadInPreviewBtn: document.getElementById('downloadInPreview'),
    dirPickerBtn: document.getElementById('dirPickerBtn'),
    resetBtn: document.getElementById('reset'),
    preview: document.getElementById('preview'),
    pagination: document.getElementById('pagination'),
    violations: document.getElementById('violations'),
    expandPreviewBtn: document.getElementById('expandPreview'),
    overlay: document.getElementById('previewOverlay'),
    overlayPreview: document.getElementById('overlayPreview'),
    overlayPagination: document.getElementById('overlayPagination'),
    downloadOverlayBtn: document.getElementById('downloadOverlay'),
    closeOverlayBtn: document.getElementById('closeOverlay'),
    uploadConfirmOverlay: document.getElementById('uploadConfirmOverlay'),
    ucContinueBtn: document.getElementById('ucContinue'),
    ucReselectBtn: document.getElementById('ucReselect'),
    ucCount: document.getElementById('ucCount'),
    ucSize: document.getElementById('ucSize'),
    uploadViolations: document.getElementById('uploadViolations'),
    thanksOverlay: document.getElementById('thanksOverlay'),
    closeThanksBtn: document.getElementById('closeThanks'),
    thanksConfirmBtn: document.getElementById('thanksConfirm'),
    stepper: document.getElementById('stepper'),
    shell: document.querySelector('.shell'),
    leftPanel: document.getElementById('left-panel'),
    previewPanel: document.getElementById('preview-panel'),
    uploadTab: document.getElementById('upload-tab'),
    rulesTab: document.getElementById('rules-tab'),
    next1: document.getElementById('to-step-2'),
    back2: document.getElementById('back-to-1'),
    next2: document.getElementById('to-step-3'),
    back3: document.getElementById('back-to-2'),
    // progress elements removed in UX simplification
    bar: document.getElementById('bar'),
    progLabel: document.getElementById('progLabel'),
    progPct: document.getElementById('progPct'),
    maxFiles: document.getElementById('maxFiles'),
    maxSize: document.getElementById('maxSize'),
    maxFileSize: document.getElementById('maxFileSize'),
    maxDepth: document.getElementById('maxDepth'),
  };

  // Show limits in UI
  els.maxFiles.textContent = ` ${LIMITS.MAX_FILES} files`;
  els.maxSize.textContent = ` ${(LIMITS.MAX_TOTAL_BYTES/1024/1024)|0} MB`;
  els.maxFileSize.textContent = ` ${(LIMITS.MAX_FILE_BYTES/1024/1024)|0} MB`;
  els.maxDepth.textContent = ` ${LIMITS.MAX_DEPTH} levels`;

  // Prefer File System Access API (Chromium) to avoid browser multi-file prompt
  if (window.showDirectoryPicker && els.dirPickerBtn) {
    els.dirPickerBtn.style.display = '';
    const fileLabel = document.querySelector('label[for="dir"]');
    if (fileLabel) fileLabel.style.display = 'none';
    if (els.input) els.input.style.display = 'none';
  }

  // State
  let pickedFiles = [];   // [{file, relPath, base, size, depth}]
  let rules = [];
  let lastPlan = null;    // preview plan
  let currentFilter = null; // current folder filter
  let currentPage = 1;    // current page for pagination
  const ITEMS_PER_PAGE = 10; // items per page

  function updateDownloadButtons(){
    const ready = !!lastPlan;
    if(els.downloadBtn) els.downloadBtn.disabled = !ready;
    if(els.downloadInPreviewBtn) els.downloadInPreviewBtn.disabled = !ready;
    if(els.downloadOverlayBtn) els.downloadOverlayBtn.disabled = !ready;
  }

  function bytes(n){
    if(n < 1024) return `${n} B`;
    if(n < 1024**2) return `${(n/1024).toFixed(1)} KB`;
    if(n < 1024**3) return `${(n/1024**2).toFixed(1)} MB`;
    return `${(n/1024**3).toFixed(2)} GB`;
  }

  function setProgress(pct, label){
    // Progress bar removed; keep this no-op for compatibility
    if (els.bar) els.bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    if (els.progPct) els.progPct.textContent = `${Math.round(pct)}%`;
    if (label && els.progLabel) els.progLabel.textContent = label;
  }

  // Extension presets and categories
  const EXTENSION_PRESETS = {
    'Documents': { extensions: ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'], icon: '📄' },
    'Images': { extensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff'], icon: '🖼️' },
    'Videos': { extensions: ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv', 'm4v'], icon: '🎥' },
    'Audio': { extensions: ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma', 'm4a'], icon: '🎵' },
    'Archives': { extensions: ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'], icon: '📦' },
    'Code': { extensions: ['js', 'ts', 'html', 'css', 'py', 'java', 'cpp', 'c', 'php', 'rb', 'go'], icon: '💻' },
    'Spreadsheets': { extensions: ['xls', 'xlsx', 'csv', 'ods'], icon: '📊' },
    'Presentations': { extensions: ['ppt', 'pptx', 'odp'], icon: '📽️' },
    'Design': { extensions: ['psd', 'ai', 'sketch', 'figma', 'xd'], icon: '🎨' },
    'Executables': { extensions: ['exe', 'msi', 'dmg', 'pkg', 'deb', 'rpm'], icon: '⚙️' }
  };

  function sanitizeFolderName(name){
    return name.replace(/[\\/:*?"<>|]/g, '-').trim() || 'Unnamed';
  }

  // Tab switching
  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
  }

  // Initialize tab listeners
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });

  // ===== Wizard Stepper =====
  let currentStep = 1;
  function setStepperUI() {
    if(!els.stepper) return;
    els.stepper.querySelectorAll('.step').forEach((btn) => {
      const s = Number(btn.dataset.step);
      btn.classList.toggle('is-active', s === currentStep);
      btn.classList.toggle('is-completed', s < currentStep);
      btn.setAttribute('aria-current', s === currentStep ? 'step' : 'false');
    });
  }
  function renderStep() {
    // Toggle panels based on step
    if(currentStep === 1){
      if(typeof closeOverlay === 'function') try{ closeOverlay(); }catch(_){/*noop*/}
      if(els.shell) els.shell.classList.remove('step-3');
      if(els.uploadTab) els.uploadTab.classList.add('active');
      if(els.rulesTab) els.rulesTab.classList.remove('active');
      if(els.previewPanel) els.previewPanel.style.display = 'none';
    }
    if(currentStep === 2){
      if(typeof closeOverlay === 'function') try{ closeOverlay(); }catch(_){/*noop*/}
      if(els.shell) els.shell.classList.remove('step-3');
      if(els.uploadTab) els.uploadTab.classList.remove('active');
      if(els.rulesTab) els.rulesTab.classList.add('active');
      if(els.previewPanel) els.previewPanel.style.display = 'none';
    }
    if(currentStep === 3){
      if(els.shell) els.shell.classList.add('step-3');
      if(els.previewPanel) els.previewPanel.style.display = '';
      // Ensure preview exists
      const v = validateSelection();
      els.violations.textContent = v.ok ? '' : ('⚠ ' + v.errors.join(' | '));
      rebuildRulesFromDOM();
      if(v.ok && rules.length > 0){
        if(!lastPlan) planPreview();
      }
      updateDownloadButtons();
    }
    setStepperUI();
  }
  function goToStep(step){
    const s = Math.max(1, Math.min(3, Number(step)||1));
    if(s === 3){
      const v = validateSelection();
      rebuildRulesFromDOM();
      if(!v.ok || rules.length === 0){
        els.violations.textContent = v.ok ? 'Add one or more rules to preview.' : ('⚠ ' + v.errors.join(' | '));
        return; // block going to preview without prerequisites
      }
    }
    currentStep = s;
    renderStep();
  }
  // Stepper click navigation
  if(els.stepper){
    els.stepper.addEventListener('click', (e)=>{
      const btn = e.target.closest('.step');
      if(!btn) return;
      goToStep(Number(btn.dataset.step));
    });
  }

  function addRuleRow(rule={type:'contains', pattern:'', target:''}){
    const card = document.createElement('div');
    card.className = 'rule-card';

    // Header with target folder badge
    const header = document.createElement('div');
    header.className = 'rule-header';
    
    const folderBadge = document.createElement('div');
    folderBadge.className = 'rule-folder-badge';
    folderBadge.textContent = rule.target || '';
    folderBadge.style.cssText = 'border:none; outline:none; background:linear-gradient(135deg, var(--main-violet), var(--primary-indigo)); color:#fff; padding:10px 20px; border-radius:999px; font-size:15px; font-weight:700; flex-shrink:0; min-height:36px; min-width:100px; white-space:nowrap';
    
    header.appendChild(folderBadge);

    // Body with rule configuration
    const body = document.createElement('div');
    body.className = 'rule-body';

    // Rule Type field
    const typeField = document.createElement('div');
    typeField.className = 'rule-field';
    const typeLabel = document.createElement('div');
    typeLabel.className = 'rule-label';
    typeLabel.textContent = 'Rule Type';
    const sel = document.createElement('select');
    ['contains','starts_with','ends_with','extension','extension_category','regex'].forEach(t=>{
      const o=document.createElement('option'); o.value=t; o.textContent=t.replace('_', ' '); sel.appendChild(o);
    });
    sel.value = rule.type;
    typeField.appendChild(typeLabel);
    typeField.appendChild(sel);

    // Pattern field
    const patternField = document.createElement('div');
    patternField.className = 'rule-field';
    const patternLabel = document.createElement('div');
    patternLabel.className = 'rule-label';
    patternLabel.textContent = 'Pattern';
    const pat = document.createElement('input');
    pat.type='text'; 
    pat.placeholder = getPlaceholderText(rule.type); 
    pat.value = rule.pattern||'';
    patternField.appendChild(patternLabel);
    patternField.appendChild(pat);

    sel.addEventListener('change',()=>{
      pat.placeholder = getPlaceholderText(sel.value);
      updatePatternInput(pat, sel.value, body);
    });

    // Target folder field
    const targetField = document.createElement('div');
    targetField.className = 'rule-field';
    const targetLabel = document.createElement('div');
    targetLabel.className = 'rule-label';
    targetLabel.textContent = 'Target Folder';
    const tgt = document.createElement('input');
    tgt.type='text'; tgt.placeholder='Folder name'; tgt.value = rule.target||'';

    // Update folder badge when target changes
    tgt.addEventListener('input', ()=>{
      folderBadge.textContent = tgt.value || '';
      rebuildRulesFromDOM();
    });

    targetField.appendChild(targetLabel);
    targetField.appendChild(tgt);

    // Create pattern pills container
    const pillsContainer = document.createElement('div');
    pillsContainer.className = 'pattern-pills';
    
    function updatePatternPills() {
      pillsContainer.innerHTML = '';
      const patternValue = pat.value.trim();
      
      if (patternValue && (sel.value === 'contains' || sel.value === 'extension')) {
        const patterns = patternValue.split(',').map(p => p.trim()).filter(p => p);
        patterns.forEach(pattern => {
          const pill = document.createElement('span');
          pill.className = 'pattern-pill';
          pill.textContent = pattern;
          pillsContainer.appendChild(pill);
        });
      } else if (patternValue) {
        const pill = document.createElement('span');
        pill.className = 'pattern-pill';
        pill.textContent = patternValue;
        pillsContainer.appendChild(pill);
      } else {
        // Only show empty pill for certain rule types that benefit from visual feedback
        if (sel.value === 'contains' || sel.value === 'extension' || sel.value === 'starts_with' || sel.value === 'ends_with') {
          const pill = document.createElement('span');
          pill.className = 'pattern-pill empty';
          pill.textContent = 'Enter pattern';
          pill.onclick = () => pat.focus();
          pillsContainer.appendChild(pill);
        }
        // For other types (regex, extension_category), don't show empty pills
      }
    }

    // Update pills when pattern or type changes
    pat.addEventListener('input', updatePatternPills);
    sel.addEventListener('change', updatePatternPills);

    body.appendChild(typeField);
    body.appendChild(patternField);
    body.appendChild(targetField);
    body.appendChild(pillsContainer);
    
    // Initial pill update
    updatePatternPills();

    // Controls
    const controls = document.createElement('div');
    controls.className = 'rule-controls';

    const up = document.createElement('button'); up.type='button'; up.textContent='↑ Move Up'; up.className='btn ghost';
    const dn = document.createElement('button'); dn.type='button'; dn.textContent='↓ Move Down'; dn.className='btn ghost';
    const del= document.createElement('button'); del.type='button'; del.textContent='✕ Delete'; del.className='btn ghost';

    up.onclick = ()=>{ if(card.previousElementSibling){ card.parentNode.insertBefore(card, card.previousElementSibling); rebuildRulesFromDOM(); }};
    dn.onclick = ()=>{ if(card.nextElementSibling){ card.parentNode.insertBefore(card.nextElementSibling, card); rebuildRulesFromDOM(); }};
    del.onclick= ()=>{ card.remove(); rebuildRulesFromDOM(); };

    [sel, pat, tgt].forEach(el=> el.addEventListener('input', rebuildRulesFromDOM));

    controls.append(up,dn,del);
    card.appendChild(header);
    card.appendChild(body);
    card.appendChild(controls);
    els.rules.appendChild(card);
    rebuildRulesFromDOM();
  }

  function getPlaceholderText(type) {
    switch(type) {
      case 'extension': return 'e.g. pdf, jpg, mp4 (comma-separated)';
      case 'extension_category': return 'Select category below';
      case 'contains': return 'e.g. invoice, report, contract (comma-separated)';
      case 'starts_with': return 'e.g. draft, temp';
      case 'ends_with': return 'e.g. _final, _backup';
      case 'regex': return 'e.g. ^[A-Z].*\\.pdf$';
      default: return 'pattern';
    }
  }

  function updatePatternInput(input, type, body) {
    if (type === 'extension_category') {
      // Replace input with dropdown for categories
      const select = document.createElement('select');
      select.innerHTML = '<option value="">Select category...</option>';
      Object.entries(EXTENSION_PRESETS).forEach(([name, data]) => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = `${data.icon} ${name} (${data.extensions.join(', ')})`;
        select.appendChild(option);
      });
      select.addEventListener('change', rebuildRulesFromDOM);
      
      // Replace the input with select in the pattern field
      const patternField = input.parentNode;
      patternField.replaceChild(select, input);
      
      // Update pills after replacement
      const pillsContainer = body.querySelector('.pattern-pills');
      if (pillsContainer) {
        pillsContainer.innerHTML = '';
        // Don't show empty pill for extension_category - the dropdown is self-explanatory
      }
    }
  }

  function rebuildRulesFromDOM(){
    rules = Array.from(els.rules.querySelectorAll('.rule-card')).map(card=>{
      const sel = card.querySelector('select');
      const patEl = card.querySelector('.rule-field:nth-child(2) input, .rule-field:nth-child(2) select');
      const tgt = card.querySelector('.rule-field:nth-child(3) input');
      return { 
        type: sel.value, 
        pattern: patEl ? patEl.value.trim() : '', 
        target: tgt ? tgt.value.trim() : '' 
      };
    }).filter(r => r.pattern && r.target);
    if(els.next2) els.next2.disabled = !(rules.length > 0);
  }

  function countDepth(relPath){
    return relPath.split('/').length - 1; // folders count
  }

  function matchRule(fileBase){
    for(const r of rules){
      try{
        const base = fileBase.toLowerCase();
        const patt = r.pattern;
        switch(r.type){
          case 'contains': {
            const patterns = patt.split(',').map(p => p.trim().toLowerCase()).filter(p => p);
            if(patterns.length > 0 && patterns.some(pattern => base.includes(pattern))) return r; break;
          }
          case 'starts_with': if(base.startsWith(patt.toLowerCase())) return r; break;
          case 'ends_with': if(base.endsWith(patt.toLowerCase())) return r; break;
          case 'extension': {
            const ext = base.split('.').pop();
            const extensions = patt.split(',').map(e => e.trim().toLowerCase()).filter(e => e);
            if(extensions.length > 0 && extensions.includes(ext)) return r; break;
          }
          case 'extension_category': {
            const ext = base.split('.').pop();
            if(EXTENSION_PRESETS[patt] && EXTENSION_PRESETS[patt].extensions.includes(ext)) return r; break;
          }
          case 'regex': {
            const re = new RegExp(patt, 'i');
            if(re.test(fileBase)) return r; break;
          }
        }
      }catch(e){ /* invalid regex -> just skip */ }
    }
    return null;
  }

  function validateSelection(){
    const errors = [];
    if(pickedFiles.length > LIMITS.MAX_FILES) errors.push(`Too many files: ${pickedFiles.length} > ${LIMITS.MAX_FILES}`);
    const totalBytes = pickedFiles.reduce((a,b)=>a+b.size,0);
    if(totalBytes > LIMITS.MAX_TOTAL_BYTES) errors.push(`Total size ${bytes(totalBytes)} exceeds ${bytes(LIMITS.MAX_TOTAL_BYTES)}`);
    const tooBig = pickedFiles.filter(f=> f.size > LIMITS.MAX_FILE_BYTES);
    if(tooBig.length) errors.push(`${tooBig.length} file(s) exceed per-file limit ${bytes(LIMITS.MAX_FILE_BYTES)}`);
    const tooDeep = pickedFiles.filter(f=> f.depth > LIMITS.MAX_DEPTH);
    if(tooDeep.length) errors.push(`${tooDeep.length} file(s) exceed folder depth limit (${LIMITS.MAX_DEPTH})`);
    return { ok: errors.length===0, errors };
  }

  function planPreview(){
    const rows = [];
    const buckets = new Map(); // target -> {count,size}
    const targetSeenNames = new Map(); // target -> Set of file names for duplicate handling later
    let unmatchedCount = 0;

    for(const info of pickedFiles){
      const base = info.base;
      const r = matchRule(base);
      const target = sanitizeFolderName(r ? r.target : 'Others');
      const key = target;
      if(!buckets.has(key)) buckets.set(key, { count:0, size:0 });
      const b=buckets.get(key); b.count++; b.size+=info.size;
      rows.push({ target, name: base, size: info.size, path: info.relPath, matched: !!r });
      if(!targetSeenNames.has(target)) targetSeenNames.set(target, new Set());
      if(!r) unmatchedCount++;
    }

    // build table html
    let html = '<table><thead><tr><th>Target folder</th><th>Count</th><th>Total size</th></tr></thead><tbody>';
    for(const [t, agg] of buckets){
      const isOthers = t === 'Others';
      const isActive = currentFilter === t;
      const badgeClass = isOthers ? 'badge clickable' : 'badge clickable';
      const badgeStyle = isOthers ?
        `background:rgba(255,93,93,.3); color:#ff5d5d; border:1px solid rgba(255,93,93,.4); font-weight:600; font-size:14px; padding:8px 16px; border-radius:999px; display:inline-block${isActive ? '; box-shadow:0 0 0 2px rgba(255,93,93,.3)' : ''}` :
        `${isActive ? 'background:rgba(90,63,207,.6); box-shadow:0 0 0 2px rgba(90,63,207,.3); font-weight:600; font-size:14px; padding:8px 16px; border-radius:999px; display:inline-block' : 'font-weight:600; font-size:14px; padding:8px 16px; border-radius:999px; display:inline-block'}`;
      const rowStyle = isOthers ? 'background:rgba(255,93,93,.05); border-left:3px solid #ff5d5d' : '';
      html += `<tr style="${rowStyle}"><td><span class="${badgeClass}" style="${badgeStyle}" onclick="filterByFolder('${t}')">${t}</span></td><td>${agg.count}</td><td>${bytes(agg.size)}</td></tr>`;
    }
    if(!buckets.size) html += '<tr><td colspan="3">No data</td></tr>';
    html += '</tbody></table>';

    // Add unmatched files info
    if(unmatchedCount > 0) {
      html += `<div style="margin-top:8px; padding:8px; background:rgba(255,93,93,.1); border:1px solid rgba(255,93,93,.2); border-radius:8px; font-size:12px; color:var(--danger)">`;
      html += `⚠️ Heads up: ${unmatchedCount} file${unmatchedCount === 1 ? '' : 's'} will go to <strong>Others/</strong> (no matching rule)`;
      html += '</div>';
    }

    // Filter files based on current filter
    let filteredRows = rows;
    if(currentFilter) {
      filteredRows = rows.filter(r => r.target === currentFilter);
    }

    // Pagination
    const totalPages = Math.ceil(filteredRows.length / ITEMS_PER_PAGE);
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const paginatedRows = filteredRows.slice(startIndex, endIndex);

    // File listing table
    const fileRows = paginatedRows.map(r=> {
      const matchedClass = r.matched ? '' : 'style="opacity:0.7"';
      return `<tr ${matchedClass}><td>${r.target}</td><td>${r.name}</td><td>${bytes(r.size)}</td></tr>`;
    }).join('');

    html += '<div style="height:8px"></div>';
    html += '<table><thead><tr><th>Target</th><th>File name</th><th>Size</th></tr></thead><tbody>' + (fileRows || '<tr><td colspan="3">—</td></tr>') + '</tbody></table>';

    // Add clear filter button if filter is active
    if(currentFilter) {
      html += `<div style="margin-top:8px; text-align:center;"><button onclick="clearFilter()" class="btn ghost" style="font-size:11px;">Clear filter (${currentFilter})</button></div>`;
    }

    els.preview.innerHTML = html;
    if(els.overlayPreview) els.overlayPreview.innerHTML = html;

    // Add pagination controls to separate container
    if(totalPages > 1) {
      let paginationHtml = '<div class="pagination">';
      paginationHtml += `<button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>« First</button>`;
      paginationHtml += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹ Prev</button>`;
      
      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      for(let i = startPage; i <= endPage; i++) {
        paginationHtml += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
      }
      
      paginationHtml += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ›</button>`;
      paginationHtml += `<button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last »</button>`;
      paginationHtml += `<span class="pagination-info">Page ${currentPage} of ${totalPages} (${filteredRows.length} files)</span>`;
      paginationHtml += '</div>';
      els.pagination.innerHTML = paginationHtml;
    } else if(filteredRows.length > 0) {
      els.pagination.innerHTML = `<div class="pagination"><span class="pagination-info">Showing ${filteredRows.length} file${filteredRows.length === 1 ? '' : 's'}</span></div>`;
    } else {
      els.pagination.innerHTML = '';
    }
    lastPlan = { rows };
    if(els.overlayPagination) els.overlayPagination.innerHTML = els.pagination.innerHTML;
    updateDownloadButtons();
  }

  function uniqueName(target, name, used){
    const set = used.get(target) || new Set();
    if(!set.has(name)) { set.add(name); used.set(target,set); return name; }
    const dot = name.lastIndexOf('.');
    const stem = dot>0 ? name.slice(0,dot) : name;
    const ext  = dot>0 ? name.slice(dot) : '';
    let i=1; let candidate;
    do{ candidate = `${stem} (${i++})${ext}`; } while(set.has(candidate));
    set.add(candidate); used.set(target,set);
    return candidate;
  }

  async function buildZip(){
    if(!lastPlan) return;
    setProgress(0, 'Packing…');

    const zip = new JSZip();
    const usedNames = new Map(); // target -> Set(name)

    // Add files to folders in zip
    for(const row of lastPlan.rows){
      const folder = zip.folder(row.target);
      const info = pickedFiles.find(f=> f.relPath === row.path);
      const safeName = uniqueName(row.target, info.base, usedNames);
      folder.file(safeName, info.file); // let JSZip read File lazily
    }

    // Generate zip with progress
    const blob = await zip.generateAsync({
      type: 'blob',
      compression: 'DEFLATE',
      compressionOptions: { level: 6 }
    }, (metadata)=>{
      const pct = 5 + metadata.percent * 0.95; // 5% -> 100%
      setProgress(pct, 'Generating ZIP…');
    });

    // Prefer File System Access API (Chromium) to avoid the download shelf UI
    if (window.showSaveFilePicker) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: 'organized.zip',
          types: [{ description: 'ZIP archive', accept: { 'application/zip': ['.zip'] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
      } catch (err) {
        // Fallback to traditional download if user cancels or API fails
        saveAs(blob, 'organized.zip');
      }
    } else {
      // Fallback for non-Chromium browsers
      saveAs(blob, 'organized.zip');
    }
    setProgress(100, 'Done');
    try { openThanksOverlay(); } catch(_){}
  }

  // ===== Event wiring =====
  if (els.dirPickerBtn && window.showDirectoryPicker) {
    els.dirPickerBtn.addEventListener('click', async ()=>{
      try {
        const dirHandle = await window.showDirectoryPicker({ mode: 'read' });
        const gathered = [];
        async function walkDirectory(handle, prefix=''){
          for await (const [name, child] of handle.entries()){
            if (child.kind === 'file'){
              const f = await child.getFile();
              const rel = prefix + name;
              gathered.push({
                file: f,
                relPath: rel,
                base: name,
                size: f.size,
                depth: rel.split('/').length - 1
              });
              if (gathered.length >= LIMITS.MAX_FILES) return; // respect max files
            } else if (child.kind === 'directory'){
              await walkDirectory(child, prefix + name + '/');
              if (gathered.length >= LIMITS.MAX_FILES) return;
            }
          }
        }
        await walkDirectory(dirHandle, '');

        // Apply selection (mirrors <input> handler)
        pickedFiles = gathered;
        const total = pickedFiles.reduce((a,b)=>a+b.size,0);
        els.stat.textContent = `${pickedFiles.length} files • ${bytes(total)}`;

        const v = validateSelection();
        els.violations.textContent = v.ok ? '' : ('⚠ ' + v.errors.join(' | '));

        setProgress(0, 'Idle');
        lastPlan = null;
        updateDownloadButtons();
        els.preview.innerHTML = '';
        els.pagination.innerHTML = '';
        currentFilter = null;
        currentPage = 1;

        const ok = validateSelection();
        if(els.next1) els.next1.disabled = !(pickedFiles.length > 0 && ok.ok);
        currentStep = 1;
        renderStep();

        if(pickedFiles.length > 0) {
          try { openUploadConfirmOverlay(); } catch(_){}
          rebuildRulesFromDOM();
          if(rules.length > 0) {
            planPreview();
            updateDownloadButtons();
          }
        }
      } catch (err) {
        // User cancelled or API failed; do nothing
      }
    });
  }
  els.input.addEventListener('change', (e)=>{
    const list = Array.from(e.target.files||[]);
    pickedFiles = list.map(f=>{
      const rel = f.webkitRelativePath || f.name; // name when single file
      return {
        file: f,
        relPath: rel,
        base: rel.split('/').pop(),
        size: f.size,
        depth: rel.split('/').length - 1
      };
    });

    const total = pickedFiles.reduce((a,b)=>a+b.size,0);
    els.stat.textContent = `${pickedFiles.length} files • ${bytes(total)}`;
    

    const v = validateSelection();
    els.violations.textContent = v.ok ? '' : ('⚠ ' + v.errors.join(' | '));

    setProgress(0, 'Idle');
    lastPlan = null;
    updateDownloadButtons();
    els.preview.innerHTML = '';
    els.pagination.innerHTML = '';
    currentFilter = null;
    currentPage = 1;
    
    // Enable next if selection valid
    const ok = validateSelection();
    if(els.next1) els.next1.disabled = !(pickedFiles.length > 0 && ok.ok);
    // Stay on Step 1 after selection
    currentStep = 1;
    renderStep();

    // Open upload confirmation modal
    if(pickedFiles.length > 0) {
      try { openUploadConfirmOverlay(); } catch(_){}
    }

    // Auto-generate preview if we have rules and files
    if(pickedFiles.length > 0) {
      rebuildRulesFromDOM();
      if(rules.length > 0) {
        planPreview();
        updateDownloadButtons();
      }
    }
  });

  els.addRule.addEventListener('click', ()=> addRuleRow());

  els.sampleRules.addEventListener('click', ()=>{
    els.rules.innerHTML='';
    [
      {type:'extension', pattern:'pdf, doc, docx, txt, rtf, odt', target:'Documents'},
      {type:'extension', pattern:'csv, xls, xlsx, ods', target:'Sheets'},
      {type:'extension', pattern:'png, jpeg, jpg, gif, webp, svg, bmp, tiff', target:'Images'},
      {type:'extension', pattern:'mp4, avi, mov, wmv, flv, webm, mkv, m4v', target:'Videos'},
      {type:'extension', pattern:'mp3, wav, flac, aac, ogg, wma, m4a', target:'Audio'},
      {type:'extension', pattern:'js, ts, html, css, py, java, cpp, c, php, rb, go', target:'Code'},
      {type:'extension', pattern:'zip, rar, 7z, tar, gz, bz2', target:'Archives'},
      {type:'contains', pattern:'invoice, receipt, bill', target:'Finance'},
      {type:'contains', pattern:'screenshot, capture, snap', target:'Screenshots'}
    ].forEach(addRuleRow);
    try { if (window.showToast) window.showToast('Sample rules added', { type: 'success' }); } catch(_){}
  });

  els.previewBtn.addEventListener('click', ()=>{
    const v = validateSelection();
    els.violations.textContent = v.ok ? '' : ('⚠ ' + v.errors.join(' | '));
    if(!v.ok){ setProgress(0,'Fix violations'); return; }

    rebuildRulesFromDOM();
    if(!rules.length){
      els.violations.textContent = 'Add one or more rules to preview.';
      setProgress(0,'Awaiting rules');
      return;
    }

    setProgress(5, 'Planning…');
    planPreview();
    setProgress(10, 'Ready to zip');
    try { if (window.showToast) window.showToast('Preview ready — looks good? Download your ZIP.', { type: 'info' }); } catch(_){}
    updateDownloadButtons();
    // If user is on step 2, advance to step 3 after preview
    if(currentStep === 2) goToStep(3);
  });

  els.downloadBtn.addEventListener('click', ()=>{
    if(!lastPlan){ setProgress(0,'Preview first'); return; }
    buildZip();
  });

  if(els.downloadOverlayBtn){
    els.downloadOverlayBtn.addEventListener('click', ()=>{
      if(!lastPlan){ setProgress(0,'Preview first'); return; }
      buildZip();
    });
  }
  if(els.downloadInPreviewBtn){
    els.downloadInPreviewBtn.addEventListener('click', ()=>{
      if(!lastPlan){ setProgress(0,'Preview first'); return; }
      buildZip();
    });
  }

  els.resetBtn.addEventListener('click', ()=>{
    els.input.value = '';
    pickedFiles = [];
    rules = [];
    lastPlan = null;
    currentFilter = null;
    currentPage = 1;
    els.stat.textContent = 'No files selected.';
    els.violations.textContent = '';
    els.preview.innerHTML='';
    els.pagination.innerHTML='';
    els.rules.innerHTML='';
    setProgress(0,'Idle');
    updateDownloadButtons();
    if(els.next1) els.next1.disabled = true;
    if(els.next2) els.next2.disabled = true;
    goToStep(1);
  });

  // Filter and pagination functions
  function filterByFolder(folderName) {
    currentFilter = currentFilter === folderName ? null : folderName;
    currentPage = 1; // Reset to first page when filtering
    planPreview();
  }

  function clearFilter() {
    currentFilter = null;
    currentPage = 1;
    planPreview();
  }

  function changePage(page) {
    if(page < 1) return;
    currentPage = page;
    planPreview();
  }

  // Make functions globally available
  window.filterByFolder = filterByFolder;
  window.clearFilter = clearFilter;
  window.changePage = changePage;

  // Seed one blank row
  addRuleRow();

  // Wizard nav buttons
  if(els.next1){ els.next1.addEventListener('click', ()=> goToStep(2)); }
  if(els.back2){ els.back2.addEventListener('click', ()=> goToStep(1)); }
  if(els.next2){ els.next2.addEventListener('click', ()=>{
    // Trigger preview first, then step 3 (previewBtn handler will advance)
    els.previewBtn.click();
  }); }
  if(els.back3){ els.back3.addEventListener('click', ()=> goToStep(2)); }

  // Enable/disable Step 2 -> Step 3 button based on rules
  const observeRulesValidity = new MutationObserver(()=>{
    rebuildRulesFromDOM();
    if(els.next2) els.next2.disabled = !(rules.length > 0);
  });
  if(els.rules){ observeRulesValidity.observe(els.rules, { childList: true, subtree: true, characterData: true }); }

  // Initialize on Step 1 and hide preview area
  goToStep(1);
  
  // ===== Overlay wiring =====
  function openOverlay(){
    if(!els.overlay) return;
    els.overlay.classList.add('is-open');
    els.overlay.setAttribute('aria-hidden','false');
    document.body.classList.add('no-scroll');
    planPreview(); // ensure overlay content is current
  }
  function closeOverlay(){
    if(!els.overlay) return;
    els.overlay.classList.remove('is-open');
    els.overlay.setAttribute('aria-hidden','true');
    document.body.classList.remove('no-scroll');
  }
  if(els.expandPreviewBtn){ els.expandPreviewBtn.addEventListener('click', openOverlay); }
  if(els.closeOverlayBtn){ els.closeOverlayBtn.addEventListener('click', closeOverlay); }
  if(els.overlay){ els.overlay.addEventListener('click', (e)=>{ if(e.target === els.overlay) closeOverlay(); }); }
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') { closeOverlay(); closeThanksOverlay(); try{ closeUploadConfirmOverlay(); }catch(_){/*noop*/} } });

  // ===== Thanks overlay wiring =====
  function openThanksOverlay(){
    if(!els.thanksOverlay) return;
    els.thanksOverlay.classList.add('is-open');
    els.thanksOverlay.setAttribute('aria-hidden','false');
    document.body.classList.add('no-scroll');
    // Focus primary CTA for accessibility
    const btn = document.getElementById('thanksCta') || els.thanksConfirmBtn;
    if(btn) try{ btn.focus(); }catch(_){/*noop*/}
  }
  function closeThanksOverlay(){
    if(!els.thanksOverlay) return;
    els.thanksOverlay.classList.remove('is-open');
    els.thanksOverlay.setAttribute('aria-hidden','true');
    document.body.classList.remove('no-scroll');
  }
  if(els.thanksConfirmBtn){ els.thanksConfirmBtn.addEventListener('click', closeThanksOverlay); }
  if(els.thanksOverlay){ els.thanksOverlay.addEventListener('click', (e)=>{ if(e.target === els.thanksOverlay) closeThanksOverlay(); }); }

  // ===== Upload Confirm overlay wiring =====
  function openUploadConfirmOverlay(){
    if(!els.uploadConfirmOverlay) return;
    const total = pickedFiles.reduce((a,b)=>a+b.size,0);
    if(els.ucCount) els.ucCount.textContent = `${pickedFiles.length} file${pickedFiles.length===1?'':'s'}`;
    if(els.ucSize) els.ucSize.textContent = bytes(total);
    const v = validateSelection();
    if(els.uploadViolations) els.uploadViolations.textContent = v.ok ? '' : ('⚠ ' + v.errors.join(' | '));
    if(els.ucContinueBtn) els.ucContinueBtn.disabled = !v.ok;
    els.uploadConfirmOverlay.classList.add('is-open');
    els.uploadConfirmOverlay.setAttribute('aria-hidden','false');
    document.body.classList.add('no-scroll');
  }
  function closeUploadConfirmOverlay(){
    if(!els.uploadConfirmOverlay) return;
    els.uploadConfirmOverlay.classList.remove('is-open');
    els.uploadConfirmOverlay.setAttribute('aria-hidden','true');
    document.body.classList.remove('no-scroll');
  }
  if(els.uploadConfirmOverlay){ els.uploadConfirmOverlay.addEventListener('click', (e)=>{ if(e.target === els.uploadConfirmOverlay) closeUploadConfirmOverlay(); }); }
  if(els.ucContinueBtn){ els.ucContinueBtn.addEventListener('click', ()=>{ closeUploadConfirmOverlay(); goToStep(2); }); }
  if(els.ucReselectBtn){ els.ucReselectBtn.addEventListener('click', ()=>{
    closeUploadConfirmOverlay();
    // Clear selection but keep rules intact
    els.input.value = '';
    pickedFiles = [];
    lastPlan = null;
    currentFilter = null;
    currentPage = 1;
    els.stat.textContent = 'No files selected.';
    els.violations.textContent = '';
    els.preview.innerHTML = '';
    els.pagination.innerHTML = '';
    updateDownloadButtons();
    goToStep(1);
    try{ els.input.focus(); setTimeout(()=>els.input.click(), 60); }catch(_){/*noop*/}
  }); }
})();
</script>
</body>
</html>
