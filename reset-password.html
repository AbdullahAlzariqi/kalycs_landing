<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password — Kalycs</title>
    <meta name="description" content="Reset your Kalycs account password." />
    <meta name="robots" content="noindex, nofollow" />

    <link rel="icon" type="image/svg+xml" sizes="any" href="/assets/favicon.svg">
    <link rel="icon" type="image/png" sizes="48x48" href="/assets/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.min.css">
    <link rel="stylesheet" href="styles.laptop.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Sono:wght@400;600;700&family=Voces:wght@400&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      .reset-card {
        max-width: 480px;
        margin: 0 auto;
        padding: clamp(24px, 4vw, 40px);
        background: var(--surface);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: var(--radius-3xl);
        box-shadow: var(--shadow);
      }
      .reset-card h1 {
        margin-top: 0;
        margin-bottom: 8px;
        text-align: center;
      }
      .reset-desc {
        text-align: center;
        color: var(--muted);
        margin-bottom: 24px;
      }
      .error-message {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
        display: none;
      }
      .success-message {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
        display: none;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container nav">
        <a class="brand" href="index.html">
          <picture>
            <source srcset="assets/logo.webp" type="image/webp" />
            <img src="assets/logo.png" alt="Kalycs logo" class="brand__logo" width="40" height="40" />
          </picture>
          <span class="brand__name">Kalycs</span>
        </a>
      </div>
    </header>

    <main id="main">
      <section class="section">
        <div class="container">
          <div class="reset-card">
            <h1 class="h2">Reset Password</h1>
            <p class="reset-desc">Enter your new password below.</p>

            <div id="error-msg" class="error-message"></div>
            <div id="success-msg" class="success-message">
              <p>Password updated successfully!</p>
              <a href="index.html" class="btn btn--primary" style="margin-top: 10px; width: 100%;">Return to Home</a>
            </div>

            <form id="reset-form" class="contact-form">
              <div class="field">
                <label for="new-password">New Password</label>
                <input id="new-password" name="new_password" type="password" required minlength="6" placeholder="At least 6 characters" />
              </div>
              <div class="field">
                <label for="confirm-password">Confirm Password</label>
                <input id="confirm-password" name="confirm_password" type="password" required placeholder="Re-enter password" />
              </div>
              
              <div class="contact-actions" style="margin-top: 16px;">
                <button class="btn btn--primary" type="submit" style="width: 100%;">Update Password</button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer">
        <div class="footer__left">
          <picture>
            <source srcset="assets/logo.webp" type="image/webp" />
            <img src="assets/logo.png" alt="Kalycs logo" class="brand__logo small" loading="lazy" decoding="async" width="40" height="40" />
          </picture>
          <span>© <span id="year"></span> Kalycs</span>
        </div>
        <div class="footer__right">
          <a href="privacy.html" class="footer__link">Privacy</a>
          <a href="terms.html" class="footer__link">Terms of Use</a>
          <a href="index.html#contact" class="footer__link">Contact</a>
        </div>
      </div>
    </footer>

    <script>
      // Initialize Supabase from environment variables via Netlify function
      let supabase;
      let SUPABASE_URL;
      let SUPABASE_ANON_KEY;

      // Year
      document.getElementById('year').textContent = new Date().getFullYear();

      const form = document.getElementById('reset-form');
      const errorDiv = document.getElementById('error-msg');
      const successDiv = document.getElementById('success-msg');
      const submitBtn = form.querySelector('button[type="submit"]');

      // Parse URL hash parameters
      function parseHashParams() {
        const hash = window.location.hash.substring(1);
        const params = {};
        hash.split('&').forEach(param => {
          const [key, value] = param.split('=');
          if (key && value) {
            params[decodeURIComponent(key)] = decodeURIComponent(value);
          }
        });
        return params;
      }

      // Load Supabase config from Netlify function
      async function initSupabase() {
        try {
          const response = await fetch('/.netlify/functions/supabase-config');
          if (!response.ok) {
            throw new Error('Failed to load Supabase configuration');
          }
          const config = await response.json();
          
          console.log('Supabase config loaded:', { 
            hasUrl: !!config.url, 
            hasAnonKey: !!config.anonKey,
            urlLength: config.url?.length,
            anonKeyLength: config.anonKey?.length
          });
          
          if (!config.url || !config.anonKey) {
            throw new Error('Supabase configuration is incomplete. Please set SUPABASE_URL and SUPABASE_ANON_KEY environment variables in Netlify.');
          }

          SUPABASE_URL = config.url;
          SUPABASE_ANON_KEY = config.anonKey;

          // Initialize Supabase client
          if (typeof createClient !== 'undefined') {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          } else if (window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          } else {
            throw new Error('Supabase client library not loaded. Please ensure the Supabase JS library is included.');
          }

          // Handle recovery tokens from URL hash
          const hashParams = parseHashParams();
          console.log('Hash params:', hashParams);
          
          if (hashParams.type === 'recovery' && hashParams.access_token) {
            console.log('Recovery tokens found, setting session...');
            
            // Store tokens for later use
            window.recoveryTokens = {
              access_token: hashParams.access_token,
              refresh_token: hashParams.refresh_token
            };

            // Clear the hash from URL for security
            window.history.replaceState(null, '', window.location.pathname);
            
            console.log('Recovery tokens stored, form ready for password update');
          } else {
            console.log('No recovery tokens in URL, checking for existing session...');
            // Check if user has an active session
            const { data: { session } } = await supabase.auth.getSession();
            console.log('Existing session:', session);
            
            if (!session && !window.recoveryTokens) {
              errorDiv.textContent = 'No valid reset session found. Please use the link from your password reset email.';
              errorDiv.style.display = 'block';
              form.style.display = 'none';
              return;
            }
          }
        } catch (err) {
          console.error('Error initializing Supabase:', err);
          errorDiv.textContent = err.message || 'Failed to initialize authentication. Please refresh the page.';
          errorDiv.style.display = 'block';
          form.style.display = 'none';
        }
      }

      // Initialize on page load
      initSupabase();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Check if Supabase is initialized
        if (!supabase) {
          errorDiv.textContent = 'Authentication is not ready. Please wait a moment and try again.';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Reset state
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        // Validation
        if (newPassword !== confirmPassword) {
          errorDiv.textContent = "Passwords do not match.";
          errorDiv.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Update Password';
          return;
        }

        if (newPassword.length < 6) {
          errorDiv.textContent = "Password must be at least 6 characters long.";
          errorDiv.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Update Password';
          return;
        }

        try {
          // If we have recovery tokens, set the session first
          if (window.recoveryTokens) {
            console.log('Setting session with recovery tokens before password update...');
            const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
              access_token: window.recoveryTokens.access_token,
              refresh_token: window.recoveryTokens.refresh_token
            });

            console.log('Session set result:', { sessionData, sessionError });

            if (sessionError) {
              throw new Error(`Failed to authenticate: ${sessionError.message}`);
            }

            if (!sessionData.session) {
              throw new Error('Could not establish session with recovery tokens');
            }

            console.log('Session established successfully');
          }

          // Update user password
          console.log('Updating password...');
          const { data, error } = await supabase.auth.updateUser({
            password: newPassword
          });

          console.log('Password update result:', { data, error });

          if (error) throw error;

          // Success
          console.log('Password updated successfully!');
          form.style.display = 'none';
          successDiv.style.display = 'block';

          // Clear recovery tokens
          delete window.recoveryTokens;

        } catch (err) {
          console.error('Error updating password:', err);
          errorDiv.textContent = err.message || "An error occurred while updating your password.";
          errorDiv.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Update Password';
        }
      });
    </script>
  </body>
</html>
